<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel - Estudiantes</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <h1>Panel de Estudiantes</h1>
    <button id="btnCerrarSesion" class="cerrar-btn">Cerrar sesi√≥n</button>

    <section class="card">
      <h2>Registrar o Actualizar estudiante</h2>
      <input type="text" id="nombre" placeholder="Nombre del estudiante" />
      <input type="email" id="correo" placeholder="Correo" />
      <input type="text" id="clase" placeholder="Clase" />
      <button id="btnAgregarActualizar">Agregar</button>
    </section>

    <section class="card">
      <h2>Lista de estudiantes</h2>
      <ul id="lista-estudiantes"></ul>
    </section>

    <section class="card">
      <h2>Subir archivo</h2>
      <label for="estudiante">Selecciona un estudiante:</label>
      <select id="estudiante"></select><br /><br />
      <input type="file" id="archivo" />
      <button id="btnSubirArchivo">Subir</button>
    </section>

    <section class="card">
      <h2>Archivos subidos</h2>
      <ul id="lista-archivos"></ul>
    </section>
  </div>

<script src="js/dashboard.js"></script>
<script> const SUPABASE_URL = "https://vxoxgnejysvdggswcvxo.supabase.co";
const SUPABASE_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4b3hnbmVqeXN2ZGdnc3djdnhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDQ5MzcsImV4cCI6MjA3MDA4MDkzN30.o4eKVi55Jc1O2nqJGtx2Bc4i3hnAddoMlPWSWtJnIK8";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let idEnEdicion = null;

const btnAgregarActualizar = document.getElementById("btnAgregarActualizar");
const btnCerrarSesion = document.getElementById("btnCerrarSesion");
const btnSubirArchivo = document.getElementById("btnSubirArchivo");

btnAgregarActualizar.addEventListener("click", agregarOActualizarEstudiante);
btnCerrarSesion.addEventListener("click", cerrarSesion);
btnSubirArchivo.addEventListener("click", subirArchivo);

async function obtenerUsuario() {
  const {
    data: { user },
    error,
  } = await supabase.auth.getUser();
  if (error || !user) {
    alert("No est√°s autenticado. Por favor inicia sesi√≥n.");
    throw new Error("Usuario no autenticado");
  }
  return user;
}

async function agregarOActualizarEstudiante() {
  const nombre = document.getElementById("nombre").value.trim();
  const correo = document.getElementById("correo").value.trim();
  const clase = document.getElementById("clase").value.trim();

  if (!nombre || !correo || !clase) {
    alert("Completa todos los campos");
    return;
  }

  try {
    const user = await obtenerUsuario();

    if (idEnEdicion) {
      const { error } = await supabase
        .from("estudiantes")
        .update({ nombre, correo, clase })
        .eq("id", idEnEdicion)
        .eq("user_id", user.id);

      if (error) {
        alert("Error al actualizar estudiante: " + error.message);
        return;
      }
      alert("Estudiante actualizado");
      idEnEdicion = null;
      btnAgregarActualizar.textContent = "Agregar";
    } else {
      const { error } = await supabase
        .from("estudiantes")
        .insert([{ nombre, correo, clase, user_id: user.id }]);

      if (error) {
        alert("Error al agregar estudiante: " + error.message);
        return;
      }
      alert("Estudiante agregado");
    }

    limpiarFormulario();
    cargarEstudiantes();
    cargarEstudiantesSelect();
  } catch (e) {
    console.error(e);
  }
}

function limpiarFormulario() {
  document.getElementById("nombre").value = "";
  document.getElementById("correo").value = "";
  document.getElementById("clase").value = "";
}

async function cargarEstudiantes() {
  try {
    const user = await obtenerUsuario();

    const { data, error } = await supabase
      .from("estudiantes")
      .select("*")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false });

    if (error) {
      alert("Error al cargar estudiantes: " + error.message);
      return;
    }

    const lista = document.getElementById("lista-estudiantes");
    lista.innerHTML = "";

    data.forEach((est) => {
      const item = document.createElement("li");
      item.innerHTML = `
        ${est.nombre} (${est.clase}) - ${est.correo}
        <div>
          <button onclick="editarEstudiante('${est.id}', '${escapeHTML(est.nombre)}', '${escapeHTML(
        est.correo
      )}', '${escapeHTML(est.clase)}')">‚úèÔ∏è</button>
          <button onclick="eliminarEstudiante('${est.id}')">üóëÔ∏è</button>
        </div>
      `;
      lista.appendChild(item);
    });
  } catch (e) {
    console.error(e);
  }
}

function escapeHTML(text) {
  return text.replace(/'/g, "\\'").replace(/"/g, "&quot;");
}

function editarEstudiante(id, nombre, correo, clase) {
  document.getElementById("nombre").value = nombre;
  document.getElementById("correo").value = correo;
  document.getElementById("clase").value = clase;
  idEnEdicion = id;
  btnAgregarActualizar.textContent = "Actualizar";
}

async function eliminarEstudiante(id) {
  if (!confirm("¬øSeguro que quieres eliminar este estudiante?")) return;

  try {
    const user = await obtenerUsuario();
    const { error } = await supabase
      .from("estudiantes")
      .delete()
      .eq("id", id)
      .eq("user_id", user.id);

    if (error) {
      alert("Error al eliminar estudiante: " + error.message);
      return;
    }
    alert("Estudiante eliminado");
    cargarEstudiantes();
    cargarEstudiantesSelect();
  } catch (e) {
    console.error(e);
  }
}

async function cargarEstudiantesSelect() {
  try {
    const user = await obtenerUsuario();

    const { data, error } = await supabase
      .from("estudiantes")
      .select("id, nombre")
      .eq("user_id", user.id)
      .order("nombre", { ascending: true });

    if (error) {
      console.error("Error al cargar estudiantes para select:", error.message);
      return;
    }

    const select = document.getElementById("estudiante");
    select.innerHTML = "";

    data.forEach((est) => {
      const option = document.createElement("option");
      option.value = est.id;
      option.textContent = est.nombre;
      select.appendChild(option);
    });
  } catch (e) {
    console.error(e);
  }
}

async function subirArchivo() {
  const archivoInput = document.getElementById("archivo");
  const archivo = archivoInput.files[0];

  if (!archivo) {
    alert("Selecciona un archivo primero.");
    return;
  }

  try {
    const user = await obtenerUsuario();

    const estudianteSeleccionado = document.getElementById("estudiante").value;
    if (!estudianteSeleccionado) {
      alert("Selecciona un estudiante para subir el archivo.");
      return;
    }

    const nombreRuta = `${user.id}/${estudianteSeleccionado}/${archivo.name}`;
    const { error } = await supabase.storage
      .from("tareas")
      .upload(nombreRuta, archivo, { cacheControl: "3600", upsert: false });

    if (error) {
      alert("Error al subir archivo: " + error.message);
      return;
    }

    alert("Archivo subido correctamente.");
    listarArchivos();
  } catch (e) {
    console.error(e);
  }
}

async function listarArchivos() {
  try {
    const user = await obtenerUsuario();

    const { data: archivos, error } = await supabase.storage
      .from("tareas")
      .list(`${user.id}`, { limit: 20 });

    const lista = document.getElementById("lista-archivos");
    lista.innerHTML = "";

    if (error) {
      lista.innerHTML = "<li>Error al listar archivos</li>";
      console.error(error);
      return;
    }

    for (const archivo of archivos) {
      const { data: signedUrlData, error: signedUrlError } = await supabase.storage
        .from("tareas")
        .createSignedUrl(`${user.id}/${archivo.name}`, 60);

      if (signedUrlError) {
        console.error("Error al generar URL firmada:", signedUrlError.message);
        continue;
      }

      const publicUrl = signedUrlData.signedUrl;
      const item = document.createElement("li");

      const esImagen = archivo.name.match(/\.(jpg|jpeg|png|gif)$/i);
      const esPDF = archivo.name.match(/\.pdf$/i);

      if (esImagen) {
        item.innerHTML = `
          <strong>${archivo.name}</strong><br>
          <a href="${publicUrl}" target="_blank">
            <img src="${publicUrl}" width="150" style="border:1px solid #ccc; margin:5px;" />
          </a>
        `;
      } else if (esPDF) {
        item.innerHTML = `
          <strong>${archivo.name}</strong><br>
          <a href="${publicUrl}" target="_blank">Ver PDF</a>
        `;
      } else {
        item.innerHTML = `<a href="${publicUrl}" target="_blank">${archivo.name}</a>`;
      }

      lista.appendChild(item);
    }
  } catch (e) {
    console.error(e);
  }
}

async function cerrarSesion() {
  const { error } = await supabase.auth.signOut();

  if (error) {
    alert("Error al cerrar sesi√≥n: " + error.message);
    console.error(error);
  } else {
    localStorage.removeItem("token");
    alert("Sesi√≥n cerrada.");
    window.location.href = "index.html";
  }
}

// Carga inicial
window.onload = () => {
  cargarEstudiantes();
  cargarEstudiantesSelect();
  listarArchivos();
};
</script>
</body>
</html>
